var updraft_restore_screen=!0;jQuery(document).ready(function(e){function t(t,a){var o=new XMLHttpRequest,n="action="+a+"&updraftplus_ajax_restore=do_ajax_restore&job_id="+t,d=0,u=!0,l=e("#updraftplus_ajax_restore_debug").length;o.open("POST",ajaxurl,!0),o.onprogress=function(e){if(e.currentTarget.status>=200&&e.currentTarget.status<300){if(-1!==e.currentTarget.responseText.indexOf("<html"))return u&&(u=!1,alert("UpdraftPlus "+updraftlion.ajax_restore_error+" "+updraftlion.ajax_restore_invalid_response)),_.append("UpdraftPlus "+updraftlion.ajax_restore_error+" "+updraftlion.ajax_restore_invalid_response),console.log("UpdraftPlus restore error: HTML detected in response could be a copy of the WordPress front page caused by mod_security"),void console.log(e.currentTarget.responseText);if(d==e.currentTarget.responseText.length)return;c=Math.round(Date.now()/1e3);var t=e.currentTarget.responseText.substr(d);d=e.currentTarget.responseText.length;for(var a=0,o=0;a<t.length;){var n=t.substr(a,7);if("RINFO:{"==n){_.append(t.substring(o,a).trim()).scrollTop(_[0].scrollHeight);var p=ud_parse_json(t.substr(a),!0);1==l&&console.log(p),r(p.parsed),o=a+p.json_last_pos-p.json_start_pos+6,a=o}else a++}_.append(t.substr(o).trim()).scrollTop(_[0].scrollHeight),_.find("input[name=connection_type]").length&&_.find("#upgrade").length&&s()}else 0==e.currentTarget.status?_.append("UpdraftPlus "+updraftlion.ajax_restore_error+" "+updraftlion.ajax_restore_contact_failed):_.append("UpdraftPlus "+updraftlion.ajax_restore_error+" "+e.currentTarget.status+" "+e.currentTarget.statusText),console.log("UpdraftPlus restore error: "+e.currentTarget.status+" "+e.currentTarget.statusText),console.log(e.currentTarget)},o.onload=function(){var t=_.find(".updraft_restore_successful, .updraft_restore_error");if(t.length){var r=e(".updraft_restore_result");r.slideDown(),f.slideUp(),f.siblings("h2").slideUp(),t.is(".updraft_restore_successful")?(r.find(".dashicons").addClass("dashicons-yes"),r.find(".updraft_restore_result--text").text(t.text()),r.addClass("restore-success")):t.is(".updraft_restore_error")&&(r.find(".dashicons").addClass("dashicons-no-alt"),r.find(".updraft_restore_result--text").text(t.text()),r.addClass("restore-error")),setTimeout(function(){_.scrollTop(_[0].scrollHeight)},500)}},o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.send(n)}function r(t){if("started"==t.stage&&(d=setInterval(function(){a()},5e3)),"finished"==t.stage&&d&&(clearInterval(d),e("#updraftplus_ajax_restore_last_activity").html("")),t&&("state"==t.type||"state_change"==t.type)){console.log(t.stage,t.data),l="files"==t.stage?t.data.entity:t.stage;var r=f.find("[data-component="+l+"]");if("files"==t.stage&&r.find(".updraft_component--progress").html(" — "+updraftlion.restore_files_progress.replace("%s1","<strong>"+t.data.fileindex+"</strong>").replace("%s2","<strong>"+t.data.total_files+"</strong>")),"db"==t.stage&&t.data.hasOwnProperty("stage")&&("table"==t.data.stage?r.find(".updraft_component--progress").html(" — "+updraftlion.restore_db_table_progress.replace("%s","<strong>"+t.data.table+"</strong>")):"stored_routine"==t.data.stage?r.find(".updraft_component--progress").html(" — "+updraftlion.restore_db_stored_routine_progress.replace("%s","<strong>"+t.data.routine_name+"</strong>")):"finished"==t.data.stage?r.find(".updraft_component--progress").html(" — "+updraftlion.finished):"begun"==t.data.stage&&r.find(".updraft_component--progress").html(" — "+updraftlion.begun+"...")),u!==l){if(u){var s=f.find("[data-component="+u+"]");s.find(".updraft_component--progress").html(""),s.removeClass("active").addClass("done")}if("finished"==l){if(r.addClass("done"),f.find("[data-component]").each(function(t,r){$el=e(r),$el.is(".done")||$el.addClass("error")}),t.data.hasOwnProperty("actions")&&"object"==typeof t.data.actions){var o=n(t.data.urls);e.isEmptyObject(o)||(e(".updraft_restore_result").before(updraftlion.ajax_restore_404_detected),e.each(o,function(t,r){e(".updraft_missing_pages").append("<li>"+r+"</li>")})),e.each(t.data.actions,function(e,t){f.after('<a href="'+t+'" class="button button-primary">'+e+"</a>")})}}else r.addClass("active")}u=l}}function a(){var t=Math.round(Date.now()/1e3),r=t-c;if(60>r)e("#updraftplus_ajax_restore_last_activity").html(updraftlion.last_activity.replace("%d",r));else{var a=120-r;0<a?e("#updraftplus_ajax_restore_last_activity").html(updraftlion.no_recent_activity.replace("%d",a)):(e("#updraftplus_ajax_restore_last_activity").html(""),o())}}function s(){e(".updraft_restore_main").addClass("show-credentials-form"),e("#message").length&&(e(".restore-credential-errors .restore-credential-errors--list").appendTo(e("#message")),e(".restore-credential-errors .restore-credential-errors--link").appendTo(e("#message")))}function o(){updraft_send_command("get_restore_resume_notice",{job_id:p},function(r){r.hasOwnProperty("status")&&"success"==r.status&&r.hasOwnProperty("html")?(d&&clearInterval(d),"plugins"!=l&&"db"!=l&&5>h?(h++,t(p,"updraft_ajaxrestore_continue")):e(".updraft_restore_main--components").prepend(r.html)):r.hasOwnProperty("error_code")&&r.hasOwnProperty("error_message")&&(d&&clearInterval(d),alert(r.error_code+": "+r.error_message),console.log(r.error_code+": "+r.error_message))},{error_callback:function(e,a,s,o){if(500==e.status&&3>m)m++,t(p,"updraft_ajaxrestore_continue");else{r({stage:"finished",type:"state_change"});var n="updraft_send_command: error: "+a+" ("+s+")";alert(n),console.log(n),console.log(e)}}})}function n(t){var r=[];return e.each(t,function(e,t){var a=new XMLHttpRequest;a.open("GET",t,!1),a.send(null),404==a.status&&r.push(t)}),r}var d,u,l,p=e("#updraftplus_ajax_restore_job_id").val(),i=e("#updraftplus_ajax_restore_action").val(),c=0,_=e("#updraftplus_ajax_restore_output"),f=e(".updraft_restore_components_list"),g=!1,h=0,m=0;t(p,i),e("#updraftplus_ajax_restore_progress").on("click","#updraft_restore_resume",function(r){r.preventDefault(),e("#updraftplus_ajax_restore_progress").slideUp(1e3,function(){e(this).remove()}),t(p,"updraft_ajaxrestore_continue")}),e(document).on("heartbeat-tick",function(e,t){if(t.hasOwnProperty("wp-auth-check")){if(!t["wp-auth-check"])return void(g=!0);if(g&&t["wp-auth-check"]&&(c=Math.round(Date.now()/1e3),g=!1),t.hasOwnProperty("updraftplus")){var r=t.updraftplus;r.hasOwnProperty("updraft_credentialtest_nonce")&&(updraft_credentialtest_nonce=r.updraft_credentialtest_nonce,c=Math.round(Date.now()/1e3))}}})});